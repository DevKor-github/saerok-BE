services:
  app:
    image: ghcr.io/devkor-github/saerok-be:dev-latest
    container_name: saerok-dev
    restart: unless-stopped
    stop_grace_period: 15s
    ports: ["8080:8080"]

    # t2.micro 안전 제한
    cpus: "0.25"
    mem_limit: "512m"

    # 런타임에 생성한 RAM env 파일을 컨테이너로 그대로 주입
    env_file:
      - /run/saerok/env.dev

    environment:
      # dev 오버레이에서 명시적으로 고정하고 싶은 값만 남김
      SPRING_PROFILES_ACTIVE: "dev"
      JAVA_OPTS: >-
        -Duser.timezone=Asia/Seoul
        -Xms128m -Xmx256m
        -XX:MaxMetaspaceSize=160m
        -XX:MaxDirectMemorySize=32m
        -XX:ReservedCodeCacheSize=48m
        -XX:+UseSerialGC
        -XX:+ExitOnOutOfMemoryError

    depends_on:
      - postgres

  postgres:
    image: postgis/postgis:17-3.5
    container_name: saerok-postgres-dev
    restart: unless-stopped
    stop_grace_period: 15s

    # 로컬 개발/디버깅도 필요하면 열어두고, 진짜 막고 싶으면 나중에 빼면 됨
    ports:
      - "5432:5432"

    environment:
      POSTGRES_DB: saerok
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}

    volumes:
      - ./postgres-data:/var/lib/postgresql/data

    # t2.micro 고려한 소박한 리소스
    cpus: "0.25"
    mem_limit: "256m"
