# docker-compose.local.yml
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: saerok-local:latest
    container_name: saerok-app
    restart: unless-stopped

    # 네가 이미 쓰는 .env 그대로 사용
    env_file:
      - ./.env

    # 필요한 것만 오버라이드
    environment:
      # 스프링 프로파일은 로컬 개발용으로 고정 (원하면 .env에 넣어도 됨)
      SPRING_PROFILES_ACTIVE: "local"

      # 호스트 DB에 붙도록 URL만 컨테이너 기준으로 덮어쓰기
      # .env에 DB_URL_DOCKER가 있으면 그 값 사용, 없으면 host.docker.internal 기본값 사용
      DB_URL: ${DB_URL_DOCKER:-jdbc:postgresql://host.docker.internal:5432/saerok}

    # Linux에서도 host.docker.internal이 동작하도록 보장
    extra_hosts:
      - "host.docker.internal:host-gateway"

    depends_on: []
    ports:
      - "8080:8080"

    # Actuator가 켜져 있으면 /actuator/health로 바꿔
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
